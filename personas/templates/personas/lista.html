{% extends 'base.html' %}

{% block titulo %}Lista de Personas{% endblock %}

{% block contenido %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="row mb-4">
    <div class="col-md-8">
        <h1> Registro de Personas</h1>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'agregar_persona' %}" class="btn btn-primary">Agregar Persona</a>
        <a href="{% url 'importar_csv' %}" class="btn btn-info">Importar CSV</a>
    </div>
</div>

{% if personas %}
    <div class="alert alert-info">
        Total de personas registradas: <strong id="totalPersonas">{{ total }}</strong> 
        <span id="resultadosBusqueda" style="display:none;">→ <strong id="resultados">0</strong> resultados encontrados</span>
    </div>

    <div class="mb-3">
        <input 
            type="text" 
            id="buscarInput" 
            class="form-control" 
            placeholder="Buscar por nombre o RUT..." 
            style="font-size: 16px; padding: 12px; border: 2px solid #1b9a8a; border-radius: 8px;"
        >
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tablaPersonas">
            <thead>
                <tr style="background-color: #e8f5f0;">
                    <th>Nombre</th>
                    <th>RUT</th>
                    <th>Organización</th>
                    <th>Teléfono</th>
                    <th class="acciones">Acciones</th>
                </tr>
            </thead>
            <tbody id="bodyTabla">
                {% for persona in personas %}
                    <tr class="filaPersona" data-nombre="{{ persona.nombre|lower }}" data-rut="{{ persona.rut|lower }}">
                        <td>{{ persona.nombre }}</td>
                        <td><code>{{ persona.rut }}</code></td>
                        <td>{{ persona.organizacion|default:"—" }}</td>
                        <td>{{ persona.fono|default:"—" }}</td>
                        <td class="acciones">
                            <a href="{% url 'editar_persona' persona.id %}" class="btn btn-sm btn-warning">Editar</a>
                            <a href="{% url 'eliminar_persona' persona.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('buscarInput').addEventListener('keyup', function() {
            const termino = this.value.toLowerCase().trim();
            const filas = document.querySelectorAll('.filaPersona');
            let resultados = 0;

            filas.forEach(fila => {
                const nombre = fila.getAttribute('data-nombre');
                const rut = fila.getAttribute('data-rut');
                
                if (nombre.includes(termino) || rut.includes(termino)) {
                    fila.style.display = '';
                    resultados++;
                } else {
                    fila.style.display = 'none';
                }
            });

            // Actualizar contador de resultados
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            const resultadosNum = document.getElementById('resultados');
            
            if (termino === '') {
                resultadosDiv.style.display = 'none';
            } else {
                resultadosDiv.style.display = 'inline';
                resultadosNum.textContent = resultados;
            }
        });
    </script>
{% else %}
    <div class="alert alert-warning">
        <strong>No hay personas registradas.</strong>
        <a href="{% url 'agregar_persona' %}" class="btn btn-primary btn-sm mt-2">Agregar la primera persona</a>
    </div>
{% endif %}
{% endblock %}
